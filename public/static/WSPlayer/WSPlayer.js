var __defProp=Object.defineProperty,__defNormalProp=(e,t,s)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,__publicField=(e,t,s)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,s),s);!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WSPlayer={})}(this,(function(e){"use strict";const t={websocketPorts:{realmonitor:"realmonitor-websocket",playback:"playback-websocket",realmonitor_ws:"9100",playback_ws:"9320",realmonitor_wss:"9102",playback_wss:"9322"},errorVideoInfo:{101:"播放延时大于8s",201:"当前音频无法播放",202:"websocket连接错误",203:"文件播放完成",401:"该用户无操作权限",404:"请求超时或未找到",405:"播放超时",406:"视频流类型解析失败，请检查通道配置",407:"请求超时",409:"请求超时或码流不支持",411:"录像播放完成",457:"时间设置错误",503:"WS连接地址错误，非当前连接的ICC服务器返回",504:"对讲失败",701:"Chrome版本低，请升级到最新的Chrome版本",702:"Firefox版本低，请升级到最新的Firefox版本",703:"Edge版本低，请升级到最新的Edge版本",defaultErrorMsg:"播放失败，请检查配置"},errorInfo:{101:"所选通道离线，无法播放",102:"登录权限过期，查询实时预览rtsp失败",103:"接口未通，请检查项目后端是否未转发接口。",201:"所选通道未查询到录像文件",202:"查询录像文件列表失败",203:"查询录像rtsp失败",204:"$0倍速无法播放音频",301:"正在对讲，无法打开音频",302:"其他设备对讲中，无法开启音频",303:"其他设备对讲中，无法开启对讲",304:"查询对讲rtsp失败",305:"http协议不支持对讲",501:"解码库未初始化完成，请稍后播放！",502:"解码库未初始化完成，请稍后对讲！",503:"请检查创建播放器时，播放器容器是否存在",601:"所操作播放器不存在",602:"所选播放器正在本地录像中，不可重复本地录像",603:"所选播放器未播放录像，不可本地录像",604:"所选播放器未开始本地录像，不可操作关闭本地录像",605:"时间跳转播放传参错误",606:"设置自适应拉伸传参错误",607:"实时预览不支持倍速播放",608:"需传入正确的$0方法：$1",701:"云台被用户$0锁定，无法操作",702:"控制云台三维定位失败$0",703:"控制云台$0$1失败$2",704:"控制云台方向失败$0"}},s={Opera:"Opera",Chrome:"Chrome",Firefox:"Firefox",Edge:"Edge",Edg:"Edg",IE:"IE",Safari:"Safari"};const i={checkBrowser:function(){const e=function(){const{userAgent:e}=navigator;return e.includes("Edge")?s.Edge:e.includes("Edg")?s.Edg:e.includes("Firefox")?s.Firefox:e.includes("Chrome")?s.Chrome:e.includes("Safari")?s.Safari:e.includes("compatible")&&e.includes("MSIE")&&e.includes("Opera")?s.IE:e.includes("Opera")?s.Opera:""}(),t=navigator.userAgent.includes("x64")||navigator.userAgent.includes("x86_64")?64:32,i=function(e){const{userAgent:t}=navigator;return t.split(e)[1].split(".")[0].slice(1)}(e);let r=!1,a=0;switch(e){case s.Chrome:r=i>=91&&64===t,a=701;break;case s.Firefox:r=i>=97,a=702;break;case s.Edge:case s.Edg:r=i>=91,a=703;break;default:r=0}return{isVersionCompliance:r,browserType:e,errorCode:a}},validFunction:function(e){return"[object Function]"===toString.call(e)},mergeObject:function e(){let t={};for(let i=0;i<arguments.length;i++){let r=arguments[i];for(let i in r){let a=r[i];s=a,"[object Object]"===toString.call(s)?t[i]=e(a):t[i]=a}}var s;return t},getDateFormatByUnderline:function(){return function(){let e=new Date;return[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()]}().join("_")},throttle:function(e,t){let s;return function(){s||(e.apply(this,arguments),s=setTimeout((()=>{s=0}),t))}},debounce:function(e,t){let s;return function(){s&&clearTimeout(s),s=setTimeout((()=>{e.apply(this,arguments),s=0}),t)}}};class r{constructor(e){this.$el=null,this.canvasElem=null,this.videoElem=null,this.wrapperDomId=e.wrapperDomId,this.domId=e.wrapperDomId+"-"+e.index,this.wsPlayer=e.wsPlayer,this.index=e.index,this.firstTime=0,this.isAudioPlay=!1,this.speed=1}initDom(){let e=this.getTemplate(),t=$(e);this.wsPlayer.$wrapper.append(t[0]),this.$el=$("#"+this.domId),this.canvasElem=document.getElementById(this.canvasId)||{},this.ivsCanvasElem=document.getElementById(this.ivsCanvasId)||{},this.pztCanvasElem=document.getElementById(this.pztCanvasId)||{},this.videoElem=document.getElementById(this.videoId);let s=this.wsPlayer.config.showIcons||{};s.streamChangeSelect||$(".select-container",this.$el).css({display:"none"}),this.setTalkIconShow(),s.audioIcon||$(".audio-icon",this.$el).css({display:"none"}),s.snapshotIcon||$(".capture-icon",this.$el).css({display:"none"}),s.localRecordIcon||$(".record-icon",this.$el).css({display:"none"}),s.closeIcon||$(".close-icon",this.$el).css({display:"none"})}setTalkIconShow(e){let{talkIcon:t}=this.wsPlayer.config.showIcons||{},s=location.protocol;t&&"https:"===s&&"real"===this.wsPlayer.type?$(".talk-icon",this.$el).css({display:"block"}):$(".talk-icon",this.$el).css({display:"none"})}initMouseEvent(){this.$el.click((e=>{this.wsPlayer.setSelectIndex(this.index),this.$el.siblings().removeClass("selected").addClass("unselected"),this.$el.removeClass("unselected").addClass("selected")})),this.$el.dblclick((e=>{if(1!==this.wsPlayer.options.config.maxNum){if(1!==this.wsPlayer.showNum){this.wsPlayer.beforeShowNum=this.wsPlayer.showNum;let e=$(`#${this.wrapperDomId} .wsplayer-item`);this.wsPlayer.resetPlayerScreen(e,this.wsPlayer.options.config.maxNum),$(`#${this.wrapperDomId}-${this.index}`).css({top:0,left:0,width:"100%",height:"100%",visibility:"visible"}),this.wsPlayer.showNum=1}else this.wsPlayer.setPlayerNum(this.wsPlayer.beforeShowNum,!0);this.wsPlayer.setSelectIndex(this.index),this.$el.siblings().removeClass("selected").addClass("unselected"),this.$el.removeClass("unselected").addClass("selected"),setTimeout((()=>{this.wsPlayer.__updatePlayerWindow()}),200)}})),$(".audio-icon",this.$el).click((e=>{if(this.wsPlayer.isTalking)this.wsPlayer.sendErrorMessage(this.isTalking?"301":"302");else{if(this.isAudioPlay)this.player.setAudioVolume(0),$(e.target).removeClass("on").addClass("off");else{if(this.player.isPlayback&&8===this.speed)return void this.wsPlayer.sendErrorMessage("204",{insert:[this.speed]});this.closeOtherAudio(),this.player.setAudioVolume(1),this.resumeAudio(),$(e.target).removeClass("off").addClass("on")}this.isAudioPlay=!this.isAudioPlay}}));$(".talk-icon",this.$el).click(i.throttle((e=>{"http:"!==location.protocol?this.wsPlayer.isTalking&&!this.isTalking?this.wsPlayer.sendErrorMessage("303"):this.isTalking?this.stopTalk():("url"===this.options.playType&&this.wsPlayer.sendMessage("notifyTalk",this.options),this.resumeAudio(),this.setAuthority({channelCode:this.options.channelData?this.options.channelData.channelCode:this.options.channelId,function:"3"},(()=>{this.wsPlayer.talkIndex=this.index,this.wsPlayer.__startTalk(this.options.channelData)}),(e=>{1103===e.code&&this.wsPlayer.sendErrorMessage(401,{type:"talk"})}))):this.wsPlayer.sendErrorMessage("305")}),2e3)),$(".capture-icon",this.$el).click((e=>{let t=(this.options.channelData||{}).name||"抓图";this.setAuthority({channelCode:this.options.channelData?this.options.channelData.channelCode:this.options.channelId,function:"4"},(()=>{this.player.capture(`抓图_${t}_${i.getDateFormatByUnderline()}`)}),(e=>{1103===e.code&&this.wsPlayer.sendErrorMessage(401,{type:"capture"})}))})),$(".close-icon",this.$el).click((e=>{this.close()})),$(".record-icon",this.$el).click((e=>{let t=(this.options.channelData||{}).name||"录像";this.isRecording?(this.isRecording=!1,this.player.stopLocalRecord(),$(e.target).removeClass("recording")):"playing"===this.status&&this.setAuthority({channelCode:this.options.channelData?this.options.channelData.channelCode:this.options.channelId,function:"8"},(()=>{this.isRecording=!0,this.player.startLocalRecord(`视频_${t}_${i.getDateFormatByUnderline()}`),$(e.target).addClass("recording")}),(e=>{1103===e.code&&this.wsPlayer.sendErrorMessage(401,{type:"record"})}))}))}closeOtherAudio(){this.wsPlayer.playerList.forEach((e=>{e.isAudioPlay&&(e.isAudioPlay=!1,e.player.setAudioVolume(0),$(".audio-icon",e.$el).removeClass("on").addClass("off"))}))}setAuthority(e,t,s){this.wsPlayer.fetchChannelAuthority?this.wsPlayer.fetchChannelAuthority(e).then((e=>{e.data.result&&t()})).catch((e=>{s(e)})):t()}resumeAudio(){if(window.wsAudioPlayer)window.wsAudioPlayer.manualResume("fromTalk");else{let e=setInterval((()=>{window.wsAudioPlayer&&(window.wsAudioPlayer.manualResume("fromTalk"),clearInterval(e))}),100)}}setStatus(){}play(){this.player.playSpeed(this.speed),this.setStatus("playing"),$(".ws-record-play",this.wsPlayer.$el).css({display:"none"}),$(".ws-record-pause",this.wsPlayer.$el).css({display:"block"})}pause(){this.player.pause(),this.setStatus("pause"),$(".ws-record-pause",this.wsPlayer.$el).css({display:"none"}),$(".ws-record-play",this.wsPlayer.$el).css({display:"block"})}close(e=!1,t=!1){this.wsPlayer.videoClosed(this.index,e,{...this.options&&this.options.channelData||{}}),this.setDomVisible($(".play-pause-wrapper",this.$el),!1),this.videoElem.style.display="none",this.canvasElem.style.display="none",this.isTalking&&!t&&this.stopTalk(),this.speed=1,this.index===this.wsPlayer.selectIndex&&("real"===this.wsPlayer.type?!e&&this.wsPlayer.setPtzChannel():(this.wsPlayer.setTimeLine([]),this.wsPlayer.__setPlaySpeed(),$(".ws-record-play",this.wsPlayer.$el).css({display:"block"}),$(".ws-record-pause",this.wsPlayer.$el).css({display:"none"}))),this.isRecording&&(this.isRecording=!1,this.player.stopLocalRecord(),$(".record-icon",this.$el).removeClass("recording")),this.wsPlayer.config.openIvs&&this.player&&this.player.closeIVS(),this.spinner&&this.spinner.stop(),this.player&&this.player.stop(),this.player&&this.player.close(),this.player&&window.wsPlayerManager.unbindPlayer(this.player.nPlayPort),e||(this.player=null,this.options=null),this.setStatus("closed")}setDomVisible(e,t){e&&e.css({visibility:t?"visible":"hidden"})}updateAdapter(e,t={}){let s=t.width/t.height,i="video"===(t.decodeMode||this.decodeMode)?this.videoElem:this.canvasElem,r=i.parentNode;t.decodeMode?(this.decodeMode=t.decodeMode,this.width=t.width,this.height=t.height):s=this.width/this.height;let a="100%",l="100%";if("selfAdaption"===e){let e=r.offsetHeight,t=r.offsetWidth,n=t/e;s>n?l=t/s+"px":s<n&&(a=e*s+"px"),$(i).css({width:a,height:l,"object-fit":"contain"}),$(this.ivsCanvasElem).css({width:a,height:l,"object-fit":"contain"}),$(this.pztCanvasElem).css({width:a,height:l,"object-fit":"contain"})}else $(i).css({width:a,height:l,"object-fit":"fill"}),$(this.ivsCanvasElem).css({width:a,height:l,"object-fit":"fill"}),$(this.pztCanvasElem).css({width:a,height:l,"object-fit":"fill"});this.player&&(this.ivsCanvasElem.width=i.offsetWidth,this.ivsCanvasElem.height=i.offsetHeight,this.player.setIVSCanvasSize(i.offsetWidth,i.offsetHeight),this.pztCanvasElem.width=i.offsetWidth,this.pztCanvasElem.height=i.offsetHeight)}}var a=globalThis&&globalThis.__assign||function(){return a=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},a.apply(this,arguments)},l={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",fadeColor:"transparent",animation:"spinner-line-fade-default",rotate:0,direction:1,speed:1,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:"0 0 1px transparent",position:"absolute"},n=function(){function e(e){void 0===e&&(e={}),this.opts=a(a({},l),e)}return e.prototype.spin=function(e){return this.stop(),this.el=document.createElement("div"),this.el.className=this.opts.className,this.el.setAttribute("role","progressbar"),o(this.el,{position:this.opts.position,width:0,zIndex:this.opts.zIndex,left:this.opts.left,top:this.opts.top,transform:"scale("+this.opts.scale+")"}),e&&e.insertBefore(this.el,e.firstChild||null),function(e,t){var s=Math.round(t.corners*t.width*500)/1e3+"px",i="none";!0===t.shadow?i="0 2px 4px #000":"string"==typeof t.shadow&&(i=t.shadow);for(var r=function(e){for(var t=/^\s*([a-zA-Z]+\s+)?(-?\d+(\.\d+)?)([a-zA-Z]*)\s+(-?\d+(\.\d+)?)([a-zA-Z]*)(.*)$/,s=[],i=0,r=e.split(",");i<r.length;i++){var a=r[i].match(t);if(null!==a){var l=+a[2],n=+a[5],o=a[4],d=a[7];0!==l||o||(o=d),0!==n||d||(d=o),o===d&&s.push({prefix:a[1]||"",x:l,y:n,xUnits:o,yUnits:d,end:a[8]})}}return s}(i),a=0;a<t.lines;a++){var l=~~(360/t.lines*a+t.rotate),n=o(document.createElement("div"),{position:"absolute",top:-t.width/2+"px",width:t.length+t.width+"px",height:t.width+"px",background:d(t.fadeColor,a),borderRadius:s,transformOrigin:"left",transform:"rotate("+l+"deg) translateX("+t.radius+"px)"}),h=a*t.direction/t.lines/t.speed;h-=1/t.speed;var p=o(document.createElement("div"),{width:"100%",height:"100%",background:d(t.color,a),borderRadius:s,boxShadow:c(r,l),animation:1/t.speed+"s linear "+h+"s infinite "+t.animation});n.appendChild(p),e.appendChild(n)}}(this.el,this.opts),this},e.prototype.stop=function(){return this.el&&("undefined"!=typeof requestAnimationFrame?cancelAnimationFrame(this.animateId):clearTimeout(this.animateId),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.el=void 0),this},e}();function o(e,t){for(var s in t)e.style[s]=t[s];return e}function d(e,t){return"string"==typeof e?e:e[t%e.length]}function c(e,t){for(var s=[],i=0,r=e;i<r.length;i++){var a=r[i],l=h(a.x,a.y,t);s.push(a.prefix+l[0]+a.xUnits+" "+l[1]+a.yUnits+a.end)}return s.join(", ")}function h(e,t,s){var i=s*Math.PI/180,r=Math.sin(i),a=Math.cos(i);return[Math.round(1e3*(e*a+t*r))/1e3,Math.round(1e3*(-e*r+t*a))/1e3]}const p=window.PlayerControl;class y extends r{constructor(e){super(e),this.currentIndex=e.index,this.wrapperDomId=e.wrapperDomId,this.canvasId=`${this.domId}-livecanvas`,this.ivsCanvasId=`${this.domId}-ivs-livecanvas`,this.pztCanvasId=`${this.domId}-pzt-livecanvas`,this.videoId=`${this.domId}-liveVideo`,this.initDom(),this.defaultStatus=$(".default-status",this.$el),this.error=$(".error",this.$el),this.controller=$(".player-control",this.$el),this.controller.dblclick((e=>{e.stopPropagation()})),this.initMouseEvent(),this.setStatus("created")}getTemplate(){return`\n        <div id="${this.domId}" style="visibility: hidden; top: 150%; left: 0; width: 0; height: 0;" class="wsplayer-item wsplayer-item-${this.index} ${0===this.index?"selected":"unselected"}">\n            <div class="ws-full-content ws-flex">\n                <canvas id="${this.canvasId}" class="kind-stream-canvas" kind-channel-id="0" width="800" height="600"></canvas>\n                <video id="${this.videoId}" class="kind-stream-canvas" kind-channel-id="0" muted style="display:none" width="800" height="600"></video>\n                <canvas id="${this.ivsCanvasId}" class="kind-stream-canvas" style="position: absolute" kind-channel-id="0" width="800" height="600"></canvas>\n                <canvas id="${this.pztCanvasId}" class="kind-stream-canvas" style="display: none; position: absolute" kind-channel-id="0" width="800" height="600"></canvas>\n            </div>\n            <div class="default-status">\n                <img src="${this.wsPlayer.prefixUrl}/WSPlayer/icon/default.png" alt="">\n            </div>\n            <div class="player-control top-control-bar">\n                <div class="stream">\n                    <div class="select-container">\n                        <div class="select-show select">\n                            <div class="code-stream">主码流</div>\n                            \x3c!-- 下拉箭头 --\x3e\n                            <img src="${this.wsPlayer.prefixUrl}/WSPlayer/icon/spread.png" />\n                        </div>\n                        <div class="stream-type" style="display: none">\n                            <ul class="select-ul">\n                                <li optionValue="主码流" stream-type="1" class="stream-type-item">主码流</li>\n                                <li optionValue="辅码流1" stream-type="2" class="stream-type-item">辅码流1</li>\n                                <li optionValue="辅码流2" stream-type="3" class="stream-type-item">辅码流2</li>\n                            </ul>\n                        </div>\n                    </div>\n                    <span class="stream-info"></span>\n                </div>\n                <div class="opt-icons">\n                    <div class="opt-icon talk-icon off" title="对讲"></div>\n                    <div class="opt-icon record-icon" title="录像"></div>\n                    <div class="opt-icon audio-icon off" title="声音"></div>\n                    <div class="opt-icon capture-icon" title="抓图"></div>\n                    <div class="opt-icon close-icon" title="关闭"></div>\n                </div>\n            </div>\n            <div class="ws-talking">对讲中...</div>\n            <div class="error">\n                <div class="error-message"></div>\n            </div>\n        </div>\n        `}initMouseEvent(){super.initMouseEvent();let e=this;this.hideTimer=null,this.$el.on("mouseenter mousemove",(e=>{["created","closed"].includes(this.status)||this.setDomVisible($(".player-control",$(`#${this.wrapperDomId}-${this.currentIndex}`)),!0),"playing"!==this.status&&"error"!==this.status||this.hideTimer&&clearTimeout(this.hideTimer)})),this.$el.on("mouseleave",(e=>{this.hideTimer=setTimeout((()=>{$(".stream-type",this.$el).hide(),this.setDomVisible($(".player-control",$(`#${this.wrapperDomId}-${this.currentIndex}`)),!1),this.streamSelectShow=!1}),300)})),this.streamSelectShow=!1,$(".select",this.$el).click((e=>{this.streamSelectShow?($(".stream-type",this.$el).hide(),this.streamSelectShow=!1):($(".stream-type",this.$el).show(),this.streamSelectShow=!0)})),$(".stream-type",this.$el).click((t=>{let s=t.target.getAttribute("stream-type");e.streamType!==s&&e.options&&e.wsPlayer.changeStreamType(e.options.channelData,s,e.index)}))}setStreamType(e){this.streamType=e;let t=$(".stream-type .select-ul",this.$el)[0].children[e-1];$(".code-stream",this.$el).text($(t).attr("optionValue")),$(t).addClass("stream-type-select").siblings().removeClass("stream-type-select")}setStatus(e,s){switch(this.wsPlayer.sendMessage("statusChanged",{status:e,windowIndex:this.index}),this.status=e,this.status){case"created":case"closed":this.setDomVisible(this.defaultStatus,!0),this.setDomVisible(this.error,!1),this.setDomVisible(this.controller,!1),this.videoElem.src="",$(".audio-icon",this.$el).removeClass("on").addClass("off");break;case"ready":case"playing":case"pause":this.setDomVisible(this.defaultStatus,!1),this.setDomVisible(this.error,!1);break;case"error":this.setDomVisible(this.defaultStatus,!1),$(".error-message",this.$el).text(t.errorVideoInfo[s.errorCode]?t.errorVideoInfo[s.errorCode]:t.errorVideoInfo.defaultErrorMsg),this.setDomVisible(this.error,!0)}}init(e){if(this.wsPlayer.config.isDynamicLoadLib&&!window.m_nModuleInitialized){let t=setTimeout((()=>{this.init(e),clearTimeout(t)}),100);return}let t=(this.options||{}).channelId===e.channelId;this.options=e,this.player&&(this.isAudioPlay&&$(".audio-icon",this.$el).removeClass("on").addClass("off"),this.close(!0,t)),this.setTalkIconShow((e.channelData||{}).domainId),this.spinner&&this.spinner.stop(),this.spinner=new n({color:"#ffffff"}).spin(this.$el[0]),this.setStatus("ready"),this.setStreamType(e.streamType),this.createPlayer(e)}startPlay(e,t){let s=this;"video"===t.decodeMode?(s.videoElem.style.display="",s.canvasElem.style.display="none"):(s.videoElem.style.display="none",s.canvasElem.style.display=""),s.updateAdapter(e.playerAdapter,t),this.width=t.width,this.height=t.height,$(".stream-info",$(`#${s.domId}`)).text(`${t.encodeMode?`${t.encodeMode}, `:""}${t.width?`${t.width}*`:""}${t.height?t.height:""}`)}createPlayer(e){let t=this;this.player=new p({wsURL:e.wsURL,rtspURL:e.rtspURL,config:this.wsPlayer.config,rtspResponseTimeout:this.wsPlayer.rtspResponseTimeout,events:{PlayStart:e=>{console.log("PlayStart",e),t.spinner.stop(),t.setStatus("playing")},DecodeStart:s=>{console.log("DecodeStart",s),t.startPlay(e,s),t.wsPlayer.sendMessage("realSuccess",e)},GetFrameRate:s=>{console.log("GetFrameRate",s),t.startPlay(e,s)},Error:s=>{if(t.player&&t.player.ws&&s.symbol===t.player.ws.symbol){if("408"===s.errorCode||"409"===s.errorCode){if("2"===String(t.streamType))return void t.wsPlayer.changeStreamType(t.options.channelData,"1",t.index);if("408"===s.errorCode)return}t.spinner.stop(),console.log("Error: "+JSON.stringify(s)),t.setStatus("error",s),t.wsPlayer.sendMessage("realError",e,s)}},FileOver:e=>{console.log("FileOver: ",e)},UpdatePlayingTime:e=>{}}}),this.player.init(this.canvasElem,this.videoElem,this.ivsCanvasElem),this.player.connect(),this.wsPlayer.config.openIvs&&this.player.openIVS(),window.wsPlayerManager.bindPlayer(this.player.nPlayPort,this.player)}startTalk(e){if(this.wsPlayer.config.isDynamicLoadLib&&!window.m_nModuleInitialized)return void this.wsPlayer.sendErrorMessage("502");this.wsPlayer.isTalking=!0,this.isTalking=!0,$(".talk-icon",this.$el).removeClass("off").addClass("on");let t=this;this.wsPlayer.__getWSUrl(e.rtspURL,e.serverIp,e.wsList).then((s=>{this.talkPlayer=new p({rtspURL:e.rtspURL,wsURL:s,isTalkService:!0,config:this.wsPlayer.config,events:{Error:e=>{"504"===e.errorCode&&(t.stopTalk(),t.wsPlayer.sendMessage("talkError",e))}}}),this.talkPlayer.talk("on"),window.wsPlayerManager.bindPlayer(this.talkPlayer.nPlayPort,this.talkPlayer),$(".ws-talking",this.$el).css({visibility:"visible"}),this.closeOtherAudio()}))}talkByUrl(e){if(this.wsPlayer.config.isDynamicLoadLib&&!window.m_nModuleInitialized)return void this.wsPlayer.sendErrorMessage("502");this.wsPlayer.isTalking=!0,this.isTalking=!0,$(".talk-icon",this.$el).removeClass("off").addClass("on");let t=this;this.talkPlayer=new p({rtspURL:e.rtspURL,wsURL:e.wsURL,isTalkService:!0,config:this.wsPlayer.config,events:{Error:e=>{"504"===e.errorCode&&(t.stopTalk(),t.wsPlayer.sendMessage("talkError",e))}}}),this.talkPlayer.talk("on"),window.wsPlayerManager.bindPlayer(this.talkPlayer.nPlayPort,this.talkPlayer),$(".ws-talking",this.$el).css({visibility:"visible"}),this.closeOtherAudio()}stopTalk(){this.talkPlayer&&window.wsPlayerManager.unbindPlayer(this.talkPlayer.nPlayPort),this.isTalking&&(this.wsPlayer.isTalking=!1,this.isTalking=!1),this.talkPlayer&&(this.talkPlayer.talk("off"),this.talkPlayer=null),$(".talk-icon",this.$el).removeClass("on").addClass("off"),$(".ws-talking",this.$el).css({visibility:"hidden"}),"url"===this.options.playType&&this.wsPlayer.sendMessage("stopTalk",this.options)}}const m=window.PlayerControl;class u extends r{constructor(e){super(e),this.currentIndex=e.index,this.wrapperDomId=e.wrapperDomId,this.speed=1,this.canvasId=`${this.domId}-recordcanvas`,this.ivsCanvasId=`${this.domId}-ivs-livecanvas`,this.videoId=`${this.domId}-recordVideo`,this.curTimestamp=0,this.initDom(),this.defaultStatus=$(".default-status",this.$el),this.error=$(".error",this.$el),this.controller=$(".player-control",this.$el),this.timeInfo=$(".time-info",this.$el),this.initMouseEvent(),this.setStatus("created")}getTemplate(){return`\n        <div id="${this.domId}" style="visibility: hidden; top: 150%; left: 0; width: 0; height: 0;" class="wsplayer-item wsplayer-item-${this.index} ${0===this.index?"selected":"unselected"}">\n            <canvas id="${this.canvasId}" class="kind-stream-canvas" kind-channel-id="0" width="800" height="600"></canvas>\n            <video id="${this.videoId}" class="kind-stream-canvas" kind-channel-id="0" muted style="display:none" width="800" height="600"></video>\n            <canvas id="${this.ivsCanvasId}" class="kind-stream-canvas" style="position: absolute" kind-channel-id="0" width="800" height="600"></canvas>\n            <div class="default-status">\n                <img src="${this.wsPlayer.prefixUrl}/WSPlayer/icon/default.png" alt="">\n            </div>\n            <div class="player-control top-control-bar">\n                <span class="stream-info"></span>\n                <div class="opt-icons">\n                    <div class="opt-icon record-icon" title="录像"></div>\n                    <div class="opt-icon audio-icon off" title="声音"></div>\n                    <div class="opt-icon capture-icon" title="抓图"></div>\n                    <div class="opt-icon close-icon" title="关闭"></div>\n                </div>\n            </div>\n            <div class="player-control record-control-bar">\n                <div class="wsplayer-progress-bar">\n                    <div class="progress-bar_background"></div>\n                    <div class="progress-bar_hover_light"></div>\n                    <div class="progress-bar_light"></div>\n                </div>\n                <div class="record-control-left">\n                    <div class="opt-icon play-ctrl-btn play-icon play"></div>\n                    <div class="time-info"></div>/<div class="time-long"></div>\n                </div>\n                <div class="record-control-right">\n                    <div class="opt-icon close-icon"></div>\n                </div>\n            </div>\n            <div class="error">\n                <div class="error-message"></div>\n            </div>\n            <div class="play-pause-wrapper">\n                <div class="play-ctrl-btn center-play-icon"></div>\n            </div>\n        </div>\n        `}initMouseEvent(){super.initMouseEvent(),this.hideTimer=null,this.$el.on("mouseenter mousemove",(e=>{["created","closed"].includes(this.status)||this.setDomVisible($(".player-control",$(`#${this.wrapperDomId}-${this.currentIndex}`)),!0),"playing"===this.status?this.hideTimer&&clearTimeout(this.hideTimer):"ready"===this.status&&this.setDomVisible(this.progressBar,!0)})),this.$el.on("mouseleave",(e=>{"pause"!==this.status&&(this.hideTimer=setTimeout((()=>{this.setDomVisible($(".player-control",$(`#${this.wrapperDomId}-${this.currentIndex}`)),!1)}),300))})),$(".wsplayer-progress-bar",this.$el).on("mousemove",(e=>{$(".progress-bar_hover_light",this.$el).css({width:e.offsetX+"px"})})),$(".wsplayer-progress-bar",this.$el).on("mouseleave",(e=>{$(".progress-bar_hover_light",this.$el).css({width:0})})),$(".play-ctrl-btn",this.$el).click((e=>{"playing"===this.status?(this.pause(),$(".play-icon",this.$el).removeClass("play").addClass("pause")):(this.play(),$(".play-icon",this.$el).removeClass("pause").addClass("play"))}))}setStatus(e,s){switch(this.wsPlayer.sendMessage("statusChanged",{status:e,windowIndex:this.index}),this.status=e,this.status){case"created":case"closed":this.setDomVisible(this.defaultStatus,!0),this.setDomVisible(this.error,!1),this.setDomVisible(this.controller,!1),$(".audio-icon",this.$el).removeClass("on").addClass("off");break;case"ready":this.setDomVisible(this.defaultStatus,!1),this.setDomVisible(this.error,!1);break;case"playing":this.wsPlayer.selectIndex===this.index&&$("#ws-record-time-box").css({visibility:"visible"}),this.setDomVisible(this.defaultStatus,!1),this.setDomVisible(this.error,!1),this.setDomVisible($(".play-pause-wrapper",this.$el),!1);break;case"pause":this.setDomVisible(this.defaultStatus,!1),this.setDomVisible(this.error,!1),this.setDomVisible(this.controller,!1),this.setDomVisible($(".play-pause-wrapper",this.$el),!0);break;case"streamError":this.wsPlayer.sendMessage("recordFinish",this.options);case"error":this.setDomVisible(this.defaultStatus,!1),$(".error-message",this.$el).text(t.errorVideoInfo[s.errorCode]?t.errorVideoInfo[s.errorCode]:t.errorVideoInfo.defaultErrorMsg),this.setDomVisible(this.error,!0)}}init(e){if(!this.wsPlayer.config.isDynamicLoadLib||window.m_nModuleInitialized)this.options=e,this.player&&(this.isAudioPlay&&$(".audio-icon",this.$el).removeClass("on").addClass("off"),this.close(!0)),this.spinner&&this.spinner.stop(),this.spinner=new n({color:"#ffffff"}).spin(this.$el[0]),this.createPlayer(e);else{let t=setTimeout((()=>{this.init(e),clearTimeout(t)}),100);this.wsPlayer.sendErrorMessage("501")}}createPlayer(e){let t=this;this.player=new m({wsURL:e.wsURL,rtspURL:e.rtspURL,isPlayback:e.isPlayback,config:this.wsPlayer.config,rtspResponseTimeout:this.wsPlayer.rtspResponseTimeout,events:{PlayStart:e=>{console.log("PlayStart"),t.setStatus("playing"),t.wsPlayer.selectIndex===t.index&&($(".ws-record-play",t.wsPlayer.$el).css({display:"none"}),$(".ws-record-pause",t.wsPlayer.$el).css({display:"block"}))},DecodeStart:s=>{console.log("DecodeStart",s),t.DecodeStart&&t.wsPlayer.config.playCenterRecordByTime&&(t.DecodeStart(),t.DecodeStart=null),t.spinner.stop(),"video"===s.decodeMode?(t.videoElem.style.display="",t.canvasElem.style.display="none"):(t.videoElem.style.display="none",t.canvasElem.style.display=""),t.updateAdapter(e.playerAdapter,s),$(".stream-info",$(`#${t.domId}`)).text(s.width?`${s.encodeMode}, ${s.width}*${s.height}`:s.encodeMode),t.wsPlayer.sendMessage("recordSuccess",e)},GetFrameRate:e=>{console.log("GetFrameRate: ",e)},GetRtspRange:s=>{console.log("GetRtspRange: ",s),"url"===e.playType&&t.wsPlayer.setTimeLine(e.records)},Error:s=>{if(t.player&&s.symbol===t.player.ws.symbol){if("408"===s.errorCode)return;t.spinner.stop(),console.log("Error: "+JSON.stringify(s)),t.setStatus("error",s),t.wsPlayer.sendMessage("recordError",e,err)}},FileOver:s=>{if(console.log("回放播放完成"),"url"===e.playType)return void t.wsPlayer.sendMessage("recordFinish",e);let i="",r=t.options.ssId,a=t.options.ssIdList||[];r&&(i=a[a.indexOf(r)+1]),!t.options.playRecordByTime||i?(t.close(),t.wsPlayer.playNextRecord(t.index,i)):(t.close(),t.setStatus("streamError",{errorCode:"411",description:"Record Finished"}))},UpdatePlayingTime:(e,s,i,r,a,l)=>{"playing"===t.status&&t.wsPlayer.__setPlayingTime(t.index,e,s,i,r,a,l)}}}),this.timeLong=e.endTime-e.startTime;let s=this.timeLong%60,i=parseInt(this.timeLong/60)%60,r=parseInt(this.timeLong/3600)%60;this.timeLongStr=`${r>0?r+":":""}${i<10?"0"+i:i}:${s<10?"0"+s:s}`,$(".time-long",this.$el).text(this.timeLongStr),this.setStatus("ready"),this.player.init(this.canvasElem,this.videoElem,this.ivsCanvasElem),this.player.connect(),this.wsPlayer.config.openIvs&&this.player.openIVS(),window.wsPlayerManager.bindPlayer(this.player.nPlayPort,this.player)}playSpeed(e){this.speed=e,1!==e&&(this.player.setAudioVolume(0),$(".audio-icon",this.$el).removeClass("on").addClass("off"),this.isAudioPlay=!1),this.player&&this.player.playSpeed(e)}}class w{constructor(){this.wsPlayerList=[],this.portToPlayer={},window.cPlusVisibleDecCallBack=this.cPlusVisibleDecCallBack.bind(this),window.cExtraDrawDataCallBack=this.cExtraDrawDataCallBack.bind(this),window.cExtraDrawDrawCallBack=this.cExtraDrawDrawCallBack.bind(this),window.cRecordDataCallBack=this.cRecordDataCallBack.bind(this),window.cRawDataCallBack=this.cRawDataCallBack.bind(this)}cPlusVisibleDecCallBack(e,t,s,i,r,a){this.portToPlayer[e]&&this.portToPlayer[e].setFrameData(e,t,s,i,r,a)}cExtraDrawDataCallBack(e,t,s,i){this.portToPlayer[e]&&this.portToPlayer[e].setIVSData(e,t,s,i)}cExtraDrawDrawCallBack(e){this.portToPlayer[e]&&this.portToPlayer[e].drawIVSData(e)}cRecordDataCallBack(e,t,s,i,r){this.portToPlayer[e]&&this.portToPlayer[e].setRecordData(e,t,s,i,r)}cRawDataCallBack(e,t,s){}bindPlayer(e,t){this.portToPlayer[e]||(this.portToPlayer[e]=t)}unbindPlayer(e){this.portToPlayer[e]=null}addWSPlayer(e){this.wsPlayerList.push()}removeWSPlayer(e){this.wsPlayerList=this.wsPlayerList.filter((t=>t===e))}}const v={clientType:"WINPC",clientMac:"30:9c:23:79:40:08",clientPushId:"",project:"PSDK",method:"MTS.Video.StartVideo",data:{optional:"/admin/API/MTS/Video/StartVideo",dataType:"3",streamType:"2",channelId:"",trackId:""}},g={clientType:"WINPC",clientMac:"30:9c:23:79:40:08",clientPushId:"",project:"PSDK",method:"MTS.Audio.StartTalk",data:{optional:"/admin/API/MTS/Audio/StartTalk?token=ff93dabe5d754ea8acb0a95dbe6c4a0f",source:"",deviceCode:"",talkType:"1",target:"",audioBit:16,audioType:2,broadcastChannels:"",sampleRate:8e3,talkmode:"",channelSeq:"0"}},f={clientType:"WINPC",clientMac:"30:9c:23:79:40:08",clientPushId:"",project:"PSDK",method:"SS.Record.QueryRecords",data:{cardNo:"",optional:"/admin/API/SS/Record/QueryRecords",diskPath:"",startIndex:"",streamType:"0",recordType:"0",recordSource:"3",endIndex:"",startTime:"",endTime:"",channelId:""}},S={clientType:"WINPC",clientMac:"30:9c:23:79:40:08",clientPushId:"",project:"PSDK",method:"SS.Playback.StartPlaybackByTime",data:{nvrId:"",optional:"/admin/API/SS/Playback/StartPlaybackByTime",recordType:"0",recordSource:"1",streamType:"1",channelId:"",startTime:"",endTime:""}},P={clientType:"WINPC",clientMac:"30:9c:23:79:40:08",clientPushId:"",project:"PSDK",method:"SS.Playback.StartPlaybackByFile",data:{ssId:"",optional:"/evo-apigw/admin/API/SS/Playback/StartPlaybackByFile",startTime:"",endTime:"",fileName:"",diskId:"",nvrId:"",recordSource:"",channelId:"",playbackMode:"0",streamId:""}};class I{constructor(e){this.realPlayer=null,this.recordPlayer=null,this.playCenterRecordByTime=e.playCenterRecordByTime,"real"===e.type?this.realPlayer=e.player:this.recordPlayer=e.player,this.playIndex=0,this.recordList=[],this.getRealRtsp=e.getRealRtsp,this.getRecords=e.getRecords,this.getRecordRtspByTime=e.getRecordRtspByTime,this.getRecordRtspByFile=e.getRecordRtspByFile,this.getTalkRtsp=e.getTalkRtsp}getCurrentRtsp(e){let t=e.split("|").filter((e=>!e.includes("localhost")&&!e.includes("127.0.0.1")&&!e.startsWith("rtsp://[")));return t.find((e=>e.includes(window.location.hostname)))||t[0]}getWSUrl(e){return e.split("|").map((e=>e.match(/(www\.)?([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+\.\w+(:\d+)?/)[0]))}openSomeWindow(e){let t=this.realPlayer||this.recordPlayer;e>t.showNum&&(e<t.maxWindow?this.playNum=e>16?25:e>9?16:e>4?9:4:this.playNum=t.maxWindow,t.setPlayerNum(this.playNum))}playRealVideo(e,t="2",s,r=!1){let a=[],l=[];e.forEach((e=>{e.isOnline?a.push(e):l.push(e)})),l.length&&this.realPlayer.sendErrorMessage(101,{channelList:l}),a.length&&(i.validFunction(this.getRealRtsp)?(this.openSomeWindow(a.length),a.map(((e,i)=>{let l=s>-1?s:this.playIndex;a.length>1&&(l+=i),v.data.streamType=t,v.data.channelId=e.id,this.getRealRtsp(JSON.parse(JSON.stringify(v))).then((s=>{if("string"==typeof s)return this.realPlayer.sendMessage("realError",e,"在传入的 getRealRtsp 方法上，resolve 返回的值应该为一个icc返回的标准对象");s.rtspURL=this.getCurrentRtsp(s.url)+"?token="+s.token,this.realPlayer.playReal({selectIndex:l,streamServerIp:s.innerIp,rtspURL:s.rtspURL,channelId:e.id,channelData:e,streamType:t,wsList:this.getWSUrl(s.url)})}),(t=>{"27001007"===t.code?this.realPlayer.sendErrorMessage(102,{channelList:[e],apiErrorInfo:t}):r?this.realPlayer.sendErrorMessage(103,{channelList:[e],apiErrorInfo:t}):this.playRealVideo([e],"1",l,!0)}))}))):this.realPlayer.sendErrorMessage(608,{insert:["请求实时预览接口","getRealRtsp"]}))}startTalk(e){i.validFunction(this.getTalkRtsp)?(g.data.deviceCode=e.deviceCode,g.data.audioBit=e.audioBit||16,g.data.sampleRate=e.sampleRate||8e3,[1,6,10,43].includes(e.deviceType)?(g.data.talkType="2",g.data.channelSeq=e.channelSeq):(g.data.talkType="1",g.data.channelSeq="0"),this.getTalkRtsp(JSON.parse(JSON.stringify(g))).then((t=>{if("string"==typeof t)return this.realPlayer.sendMessage("realError",e,"在传入的 getTalkRtsp 方法上，resolve 返回的值应该为一个icc返回的标准对象");let s=this.getCurrentRtsp(t.url)+"?token="+t.token;this.realPlayer.playerList[this.realPlayer.talkIndex].startTalk({rtspURL:s,serverIp:t.innerIp,wsList:this.getWSUrl(t.url)})})).catch((t=>{this.realPlayer.sendErrorMessage(401,{type:"talk"},t),this.realPlayer.sendErrorMessage(304,{channelList:[e],apiErrorInfo:t})}))):this.realPlayer.sendErrorMessage(608,{insert:["请求对讲接口","getTalkRtsp"]})}getRecordList(e,t){if(!i.validFunction(this.getRecords))return void this.recordPlayer.sendErrorMessage(608,{insert:["请求录像接口","getRecords"]});f.data.streamType=e.streamType||"0",f.data.recordType=e.recordType||"0",f.data.recordSource=e.recordSource,f.data.startTime=e.startTime,f.data.endTime=e.endTime;let s="number"==typeof e.windowIndex?e.windowIndex:e.channelList.length>1?0:this.playIndex;e.channelList.forEach((i=>{f.data.channelId=i.id,this.getRecords(JSON.parse(JSON.stringify(f))).then((r=>{let a=(r.records||[]).sort(((e,t)=>e.startTime-t.startTime));a.length?(e.channelList.length>1&&this.openSomeWindow(s+1),this.getRecordRtsp({...e,channel:i},a.map((e=>(e.isImportant="2"===e.recordType,e))),!e.isUpdateRecords,s,t),s++):this.recordPlayer.sendErrorMessage(201,{channelList:[i]})}),(e=>{this.recordPlayer.sendErrorMessage(202,{channelList:[i],apiErrorInfo:e})}))}))}getRecordRtsp(e,t,s=!0,r,a){let l=null,n=t[0].recordSource||e.recordSource,o=e.ssId,d=[],c=!1;if(2===Number(n)||this.playCenterRecordByTime){if(!i.validFunction(this.getRecordRtspByTime))return void this.recordPlayer.sendErrorMessage(608,{insert:["请求录像接口","getRecordRtspByTime"]});c=!0,S.data.streamType=t[0].streamType||e.streamType||"0",S.data.recordType="1",S.data.recordSource=n,S.data.startTime=e.startTime,S.data.endTime=e.endTime,S.data.channelId=e.channel.id,S.data.streamId=t[0].streamId||"",o=o||t[0].ssId,d=Array.from(new Set(t.map((e=>e.ssId)))),S.data.ssId=o,l=this.getRecordRtspByTime(JSON.parse(JSON.stringify(S)))}else if(3===Number(n)){if(!i.validFunction(this.getRecordRtspByFile))return void this.recordPlayer.sendErrorMessage(608,{insert:["请求录像接口","getRecordRtspByFile"]});let s=t[0];P.data={ssId:s.ssId,optional:"/evo-apigw/admin/API/SS/Playback/StartPlaybackByFile",startTime:s.startTime,endTime:s.endTime,fileName:s.recordName,diskId:s.diskId,nvrId:"",recordSource:s.recordSource?s.recordSource:"3",channelId:e.channel.id,playbackMode:"0",streamId:s.streamId},l=this.getRecordRtspByFile(JSON.parse(JSON.stringify(P)))}l&&l.then((i=>"string"==typeof i?this.realPlayer.sendMessage("realError",channel,"在传入的 getRecordRtspByTime/getRecordRtspByFile 方法上，resolve 返回的值应该为一个icc返回的标准对象"):(i.channelId=e.channel.id,i.rtspURL=this.getCurrentRtsp(i.url)+"?token="+i.token,i.wsList=this.getWSUrl(i.url),i.rtspURL?(i.channelData=e.channel,void this.recordPlay(i,r,o,d,e.isJumpPlay,a,c).then((()=>{let i=this.recordList[r];if(s)this.recordList[r]={...e,recordList:t,recordIndex:0,isPlaying:!0};else{let e=t[0].recordName;i.recordIndex=i.recordList.findIndex((t=>t.recordName===e)),i.isPlaying=!0}this.playIndex===r&&(s||(t=i.recordList,i.isPlaying=!0),this.setTimeLine(t))}))):(this.recordPlayer.sendErrorMessage(201,{channelList:[e.channel]}),void console.warn("所选通道未查询到录像文件")))),(t=>{this.recordPlayer.sendErrorMessage(203,{channelList:[e.channel],apiErrorInfo:t})}))}recordPlay(e,t,s,i,r,a,l){return new Promise((n=>{this.recordPlayer.playRecord({...e,streamServerIp:e.innerIp,selectIndex:t,ssId:s,ssIdList:i,isJumpPlay:r,playRecordByTime:l||this.recordPlayer.config.playCenterRecordByTime&&!!s},a).then((()=>n()))}))}setTimeLine(e){this.recordPlayer.setTimeLine(e)}clickRecordTimeLine(e,t){let s=this.recordList[this.playIndex],i=s.startTime;i=new Date(1e3*i).setHours(0),i=new Date(i).setMinutes(0),i=new Date(i).setSeconds(0)/1e3,this.playCenterRecordByTime||(i+=e);let r={channelList:[s.channel],startTime:i,endTime:s.endTime,recordSource:s.recordSource,isUpdateRecords:!0,ssId:t,isJumpPlay:!0};this.getRecordList(r,{DecodeStart(){this.player.playByTime(e)}})}playNextRecord(e,t){if(t){if(!i.validFunction(this.getRecordRtspByTime))return void this.recordPlayer.sendErrorMessage(608,{insert:["请求录像接口","getRecordRtspByTime"]});let s=this.recordList[e],r=s.recordList.find((e=>e.ssId===t));S.data.streamType=r.streamType||"0",S.data.recordType="1",S.data.recordSource=r.recordSource,S.data.startTime=new Date(1e3*r.startTime).setHours(0,0,0)/1e3,S.data.endTime=new Date(1e3*r.endTime).setHours(23,59,59)/1e3,S.data.channelId=r.channelId,S.data.ssId=t,S.data.streamId=r.streamId||"";let a=Array.from(new Set(s.recordList.map((e=>e.ssId))));return void this.getRecordRtspByTime(JSON.parse(JSON.stringify(S))).then((i=>{i.channelId=r.channelId,i.rtspURL=this.getCurrentRtsp(i.url)+"?token="+i.token,i.wsList=this.getWSUrl(i.url),this.recordPlay(i,e,t,a,!0).then((()=>{this.setTimeLine(s.recordList)}))}))}if(!i.validFunction(this.getRecordRtspByFile))return void this.recordPlayer.sendErrorMessage(608,{insert:["请求录像接口","getRecordRtspByFile"]});let s=this.recordList[e];s.recordIndex++,s.isPlaying=!0;let r=s.recordList[s.recordIndex];r&&(P.data={ssId:r.ssId,optional:"/evo-apigw/admin/API/SS/Playback/StartPlaybackByFile",startTime:r.startTime,endTime:r.endTime,fileName:r.recordName,diskId:r.diskId,nvrId:"",recordSource:r.recordSource,channelId:r.channelId,playbackMode:"0",streamId:r.streamId},this.getRecordRtspByFile(JSON.parse(JSON.stringify(P))).then((t=>{t.rtspURL=this.getCurrentRtsp(t.url)+"?token="+t.token,t.wsList=this.getWSUrl(t.url),t.rtspURL?this.recordPlay(t,e,"",[],!0).then((()=>{this.setTimeLine(s.recordList)})):this.recordPlayer.sendErrorMessage(201,{channelList:[s.channel]})}),(e=>{this.recordPlayer.sendErrorMessage(203,{channelList:[s.channel],apiErrorInfo:e})})))}changeTimeLine(e){let t=this.recordList[e];t&&t.isPlaying&&this.setTimeLine(t.recordList)}videoClosed(e,t,s){this.recordList[e]&&(this.recordList[e].isPlaying=!1)}setPlayIndex(e){this.playIndex=e}}class x{constructor(e={},t){this.el=e.el,this.wsPlayer=t,this.prefixUrl=e.prefixUrl||"./static",this.$el=$("#"+this.el),this.$el&&!this.$el.children().length&&this.__createPanTilt(),this.channel=null,this.channelCodeForPositionList=[],this.setPtzDirection=e.setPtzDirection,this.setPtzCamera=e.setPtzCamera,this.controlSitPosition=e.controlSitPosition,this.mousedownCanvasEvent=this.__mousedownCanvasEvent.bind(this),this.mousemoveCanvasEvent=this.__mousemoveCanvasEvent.bind(this),this.mouseupCanvasEvent=this.__mouseupCanvasEvent.bind(this),this.clickDirectFlag=!1}setChannel(e){this.channel=e;let t=this.wsPlayer.selectIndex,s=this.channelCodeForPositionList[t];if(!e)return $(".ws-pan-tilt-mask",this.$el).css({display:"block"}),$(".ws-pan-tilt-mask-position",this.$el).css({display:"none"}),void this.__removeCanvasEvent();s?s!==e.id?(this.channelCodeForPositionList[t]=null,this.__removeCanvasEvent()):this.__openSitPosition(!0):this.openSitPositionFlag&&this.__removeCanvasEvent();let i=e.capability;switch(e.cameraType+""){case"1":parseInt(i,2)&parseInt("100",2)||parseInt(i,2)&parseInt("10000000000000000",2)?$(".ws-pan-tilt-mask-zoom",this.$el).css({display:"none"}):$(".ws-pan-tilt-mask-zoom",this.$el).css({display:"block"}),parseInt(i,2)&parseInt("10000000000000000",2)?($(".ws-pan-tilt-mask-direction",this.$el).css({display:"none"}),$(".ws-pan-tilt-mask-position",this.$el).css({display:"block"}),this.__removeCanvasEvent()):($(".ws-pan-tilt-mask-direction",this.$el).css({display:"block"}),$(".ws-pan-tilt-mask-position",this.$el).css({display:"none"})),$(".ws-pan-tilt-mask-aperture",this.$el).css({display:"block"});break;case"2":$(".ws-pan-tilt-mask",this.$el).css({display:"none"}),$(".ws-pan-tilt-mask-position",this.$el).css({display:"none"});break;default:$(".ws-pan-tilt-mask",this.$el).css({display:"block"}),$(".ws-pan-tilt-mask-position",this.$el).css({display:"none"}),this.__removeCanvasEvent()}}__createPanTilt(){this.$el.append(`\n            <div class="ws-pan-tilt-control">\n                <div class="ws-pan-tilt-circle-wrapper">\n                    \x3c!--云台方向控制--\x3e\n                    <div class="ws-pan-tilt-circle-rotate">\n                        <div class="ws-pan-tilt-circle">\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-t.svg" title="上" direct="1"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-rt.svg" title="右上" direct="7"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-r.svg" title="右" direct="4"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-rb.svg" title="右下" direct="8"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-b.svg" title="下" direct="2"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-lb.svg" title="左下" direct="6"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-l.svg" title="左" direct="3"/></div>\n                            <div class="ws-pan-tilt-direction-item"><img src="${this.prefixUrl}/WSPlayer/icon/arrow-lt.svg" title="左上" direct="5"/></div>\n                            <div class="ws-pan-tilt-inner-circle">\n                                <img\n                                    class="ws-pan-tilt-pzt-select"\n                                    src="${this.prefixUrl}/WSPlayer/icon/ptz-select.svg"\n                                    title="三维定位"\n                                />\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!--云台变倍、聚焦、光圈控制--\x3e\n                <div class="ws-cloud-control-wrapper">\n                    <div class="ws-pan-tilt-control-item"><img src="${this.prefixUrl}/WSPlayer/icon/ptz-icon1.svg" title="变倍-" operateType="1" direct="2"/></div>\n                    <div class="ws-pan-tilt-control-item"><img src="${this.prefixUrl}/WSPlayer/icon/ptz-icon2.svg" title="变倍+" operateType="1" direct="1"/></div>\n                    <div class="cloud-control-separate"></div>\n                    <div class="ws-pan-tilt-control-item"><img src="${this.prefixUrl}/WSPlayer/icon/ptz-icon3.svg" title="聚焦-" operateType="2" direct="2"/></div>\n                    <div class="ws-pan-tilt-control-item"><img src="${this.prefixUrl}/WSPlayer/icon/ptz-icon4.svg" title="聚焦+" operateType="2" direct="1"/></div>\n                    <div class="cloud-control-separate"></div>\n                    <div class="ws-pan-tilt-control-item"><img src="${this.prefixUrl}/WSPlayer/icon/ptz-icon5.svg" title="光圈-" operateType="3" direct="2"/></div>\n                    <div class="ws-pan-tilt-control-item"><img src="${this.prefixUrl}/WSPlayer/icon/ptz-icon6.svg" title="光圈+" operateType="3" direct="1"/></div>\n                </div>\n                \n                \x3c!--遮罩，当通道没有云台功能时，使用遮罩遮住云台按钮--\x3e\n                \x3c!--方向按钮遮罩--\x3e\n                <div class="ws-pan-tilt-mask ws-pan-tilt-mask-direction"></div>\n                \x3c!--三维定位遮罩--\x3e\n                <div class="ws-pan-tilt-mask ws-pan-tilt-mask-position"></div>\n                \x3c!--变倍、聚焦遮罩--\x3e\n                <div class="ws-pan-tilt-mask ws-pan-tilt-mask-zoom"></div>\n                \x3c!--光圈遮罩--\x3e\n                <div class="ws-pan-tilt-mask ws-pan-tilt-mask-aperture"></div>\n            </div>\n        `),$(".ws-pan-tilt-circle",this.$el).mouseup((e=>{if(this.clickDirectFlag){this.clickDirectFlag=!1;let t=this.__getDirect(e.target);t&&this.__setPtzDirection(t,"0")}})),$(".ws-pan-tilt-circle",this.$el).mouseout((e=>{if(this.clickDirectFlag){this.clickDirectFlag=!1;let t=this.__getDirect(e.target);t&&this.__setPtzDirection(t,"0")}})),$(".ws-pan-tilt-circle",this.$el).mousedown(this._throttle((e=>{if(!this.clickDirectFlag){let t=this.__getDirect(e.target);t&&(this.clickDirectFlag=!0,this.__setPtzDirection(t,"1"))}}),1e3)),$(".ws-pan-tilt-control-item img",this.$el).mouseup((e=>{this.__setPtzCamera(e.target.getAttribute("operateType"),e.target.getAttribute("direct"),"0")})),$(".ws-pan-tilt-control-item img",this.$el).mouseout((e=>{this.__setPtzCamera(e.target.getAttribute("operateType"),e.target.getAttribute("direct"),"0")})),$(".ws-pan-tilt-control-item img",this.$el).mousedown(this._throttle((e=>{this.__setPtzCamera(e.target.getAttribute("operateType"),e.target.getAttribute("direct"),"1")}),1e3)),$(".ws-pan-tilt-pzt-select",this.$el).click((e=>{this.__openSitPosition(!this.openSitPositionFlag)}))}__getDirect(e){let t=e.getAttribute("direct");if(!t){let s=e.childNodes[0];s&&s.getAttribute&&(t=s.getAttribute("direct"))}return t}__setPtzDirection(e,t){const s={project:"PSDK",method:"DMS.Ptz.OperateDirect",data:{direct:e,command:t,stepX:"4",stepY:"4",channelId:this.channel.id}};this.setPtzDirection&&this.setPtzDirection(s).then((e=>{let s=e.data||e;"1"===t&&s.result&&"0"===s.result&&this.wsPlayer.sendErrorMessage(701,{insert:[e.data.lockUser.userName],apiErrorInfo:e})})).catch((e=>{let s=[""];1103===(e.data||e).code&&(s=["：您无权限进行此操作"]),"1"===t&&this.wsPlayer.sendErrorMessage(704,{apiErrorInfo:e,insert:s})}))}__setPtzCamera(e,t,s){const i={project:"PSDK",method:"DMS.Ptz.OperateCamera",data:{operateType:e,direct:t,command:s,step:"4",channelId:this.channel.id}};this.setPtzCamera&&this.setPtzCamera(i).then((e=>{let t=e.data||e;"1"===s&&t.result&&"0"===t.result&&this.wsPlayer.sendErrorMessage(701,{insert:[e.data.lockUser.userName],apiErrorInfo:e})})).catch((e=>{let t=["","变倍","变焦","光圈"],r=["","+","-"],a=["","",""];1103===(e.data||e).code&&(a=[t[i.data.operateType],r[i.data.direct],"：您无权限进行此操作"]),"1"===s&&this.wsPlayer.sendErrorMessage(703,{apiErrorInfo:e,insert:a})}))}__openSitPosition(e){this.openSitPositionFlag=e;let t=this.wsPlayer.playerList,s=this.wsPlayer.selectIndex;this.canvasElem=t[s].pztCanvasElem,this.canvasElem.addEventListener("mousedown",this.mousedownCanvasEvent),this.canvasElem.addEventListener("mousemove",this.mousemoveCanvasEvent),this.canvasElem.addEventListener("mouseup",this.mouseupCanvasEvent),this.canvasContext=this.canvasElem.getContext("2d"),this.canvasContext.lineWidth=2,this.canvasContext.strokeStyle="#009cff",this.openSitPositionFlag?(this.channelCodeForPositionList[s]=this.channel.id,$(this.canvasElem).css({display:"block"}),$(".ws-pan-tilt-pzt-select",this.$el).attr({src:`${this.prefixUrl}/WSPlayer/icon/ptz-select-hover.svg`})):(this.channelCodeForPositionList[s]=null,$(this.canvasElem).css({display:"none"}),$(".ws-pan-tilt-pzt-select",this.$el).attr({src:`${this.prefixUrl}/WSPlayer/icon/ptz-select.svg`}))}__mousedownCanvasEvent(e){e.target===this.canvasElem&&(e.offsetX||e.layerX)&&(this.pointX=e.offsetX||e.layerX,this.pointY=e.offsetY||e.layerY,this.startDraw=!0)}__mousemoveCanvasEvent(e){if(e.target===this.canvasElem&&this.startDraw&&(e.offsetX||e.layerX)){const t=e.offsetX||e.layerX,s=e.offsetY||e.layerY,i=t-this.pointX,r=s-this.pointY;this.canvasContext.clearRect(0,0,this.canvasElem.width,this.canvasElem.height),this.canvasContext.beginPath(),this.canvasContext.strokeRect(this.pointX,this.pointY,i,r)}}__mouseupCanvasEvent(e){if(e.target===this.canvasElem&&(e.offsetX||e.layerX)){this.startDraw=!1;const t=e.offsetX||e.layerX,s=e.offsetY||e.layerY;let i="",r="",a="";const l=(t+this.pointX)/2,n=(s+this.pointY)/2,o=this.canvasElem.width/2,d=this.canvasElem.height/2,c=Math.abs(t-this.pointX),h=Math.abs(s-this.pointY),p=t<this.pointX;i=8192*(l-o)*2/this.canvasElem.width,r=8192*(n-d)*2/this.canvasElem.height,t===this.pointX||s===this.pointY?a=0:(a=this.canvasElem.width*this.canvasElem.height/(c*h),p&&(a=-a)),this.canvasContext.clearRect(0,0,this.canvasElem.width,this.canvasElem.height),this.__controlSitPosition(i,r,a)}}__removeCanvasEvent(){this.canvasElem&&(this.canvasElem.removeEventListener("mousedown",this.mousedownCanvasEvent),this.canvasElem.removeEventListener("mousemove",this.mousemoveCanvasEvent),this.canvasElem.removeEventListener("mouseup",this.mouseupCanvasEvent),$(this.canvasElem).css({display:"none"}),this.canvasElem=null,this.canvasContext=null,this.openSitPositionFlag=!1,$(".ws-pan-tilt-pzt-select",this.$el).attr({src:`${this.prefixUrl}/WSPlayer/icon/ptz-select.svg`}))}__controlSitPosition(e,t,s){const i={project:"PSDK",method:"DMS.Ptz.SitPosition",data:{magicId:localStorage.getItem("magicId")||"",pointX:String(Math.round(e)),pointY:String(Math.round(t)),pointZ:String(Math.round(s)),extend:"1",channelId:this.channel.id}};this.controlSitPosition&&this.controlSitPosition(i).then((e=>{let t=e.data||e;t.result&&"0"===t.result&&this.wsPlayer.sendErrorMessage(701,{insert:[e.data.lockUser.userName],apiErrorInfo:e})})).catch((e=>{let t=[""];1103===(e.data||e).code&&(t[0]="：您无权限进行此操作"),this.wsPlayer.sendErrorMessage(702,{apiErrorInfo:e,insert:t})}))}_throttle(e,t){let s=0;return function(...i){const r=(new Date).getTime();if(!(r-s<t))return s=r,e.apply(this,i)}}}const b={num:1,maxNum:25,showControl:!0,showRecordProgressBar:!0,isDynamicLoadLib:!0,onlyLoadSingleLib:!0,useNginxProxy:!1,openIvs:!0,ivsTypeArr:[1,2],useH264MSE:!0,useH265MSE:!0,showIcons:{streamChangeSelect:!0,talkIcon:!0,localRecordIcon:!0,audioIcon:!0,snapshotIcon:!0,closeIcon:!0},downloadMp4Record:!0,localRecordSize:100,playCenterRecordByTime:!1},k=100,T=100/k,C=20;let E,R,L={},M=!0,_="",D={x:0,y:0},N=[],A={},U={},W=0,B="",z=()=>{try{document.querySelector(E).onselectstart=function(){return!1}}catch{setTimeout((()=>{z()}),200)}};function F(e=[]){if(!e.length||1===e.length)return N=[{wStep:k,hStep:k,tStep:0,lStep:0,selectIndex:0}],N;e=e.sort(((e,t)=>e.tStep-t.tStep));for(let t=0;t<e.length-1;t++)if(e[t].tStep===e[t+1].tStep&&e[t].lStep>e[t+1].lStep){let s={...e[t]};e[t]={...e[t+1]},e[t+1]=s}return e.map(((e,t)=>(e.selectIndex=t,e)))}function V(e,t){let s="";return"x"===t&&(s=`<div id="division-move-line" style="position: absolute; background: #1d79f4; top: ${e.tStep*T}%; left: ${e.lStep*T}%; width: 2px; height: ${e.hStep*T}%; "></div>`),"y"===t&&(s=`<div id="division-move-line" style="position: absolute; background: #1d79f4; top: ${e.tStep*T}%; left: ${e.lStep*T}%; width: ${e.wStep*T}%; height: 2px; "></div>`),s}function O(e){return`<div\n        id="dom-item-${e.selectIndex}"\n        class="${M?"dom-item-flex":"dom-item"}"\n        style="top: ${e.top}%; left: ${e.left}%; width: ${e.width}%; height: ${e.height}%;"\n    >\n        <div class="point-n-resize" id="dom-item-${e.selectIndex}-bottom-border" style="bottom: -4px; left: 0; width: 100%; height: 6px;"></div>\n        <div class="point-e-resize" id="dom-item-${e.selectIndex}-right-border" style="top: 0; right: -4px; width: 6px; height: 100%;"></div>\n        <div id="dom-item-${e.selectIndex}-btn" class="dom-item-split-btn"></div>\n        <div id="dom-item-${e.selectIndex}-delete-btn" class="dom-item-merge-btn"></div>\n    </div>`}function j(e=[]){M=!1;let t=[];e.forEach((e=>{t.push(O({selectIndex:e.selectIndex,width:e.wStep*T,height:e.hStep*T,top:e.tStep*T,left:e.lStep*T}))})),R.innerHTML=t.join(""),e.forEach((e=>{document.querySelector(`#dom-item-${e.selectIndex}-btn`).addEventListener("click",(()=>{var t;t=e,N.length!==C?1===t.wStep&&1===t.hStep||(t.wStep>=t.hStep?(N.push({...t,lStep:t.lStep+Math.floor(t.wStep/2),wStep:Math.ceil(t.wStep/2)}),N[t.selectIndex]={...t,wStep:Math.floor(t.wStep/2)}):(N.push({...t,tStep:t.tStep+Math.floor(t.hStep/2),hStep:Math.ceil(t.hStep/2)}),N[t.selectIndex]={...t,hStep:Math.floor(t.hStep/2)}),J()):L.onError(`自定义播放器只支持最大分割${C}个窗口`)})),document.querySelector(`#dom-item-${e.selectIndex}-delete-btn`).addEventListener("click",(()=>{!function(e){if(1===N.length)return;let t=N.findIndex((t=>t.wStep===e.wStep&&t.lStep===e.lStep&&(t.tStep+t.hStep===e.tStep||e.tStep+e.hStep===t.tStep)||t.hStep===e.hStep&&t.tStep===e.tStep&&(t.lStep+t.wStep===e.lStep||e.lStep+e.wStep===t.lStep)));if(t>-1){let s=N[t];s.tStep===e.tStep&&(s.selectIndex>e.selectIndex?(N[e.selectIndex].wStep=e.wStep+s.wStep,N.splice(s.selectIndex,1)):(N[s.selectIndex].wStep=s.wStep+e.wStep,N.splice(e.selectIndex,1))),s.lStep===e.lStep&&(s.selectIndex>e.selectIndex?(N[e.selectIndex].hStep=e.hStep+s.hStep,N.splice(s.selectIndex,1)):(N[s.selectIndex].hStep=s.hStep+e.hStep,N.splice(e.selectIndex,1)))}J()}(e)})),document.querySelector(`#dom-item-${e.selectIndex}-right-border`).addEventListener("mousedown",(t=>{e.lStep+e.wStep!==k&&(_="right-border",D={x:0},W=0,A=function({wStep:e,lStep:t,selectIndex:s},i){let r=i.filter((s=>s.lStep+s.wStep===t+e)).sort(((e,t)=>e.tStep-t.tStep)),a=i.filter((s=>s.lStep===t+e)).sort(((e,t)=>e.tStep-t.tStep));for(var l=0;l<r.length-1;l++)r[l].tStep+r[l].hStep!==r[l+1].tStep&&(s<=r[l].selectIndex?r.splice(l+1):(r.splice(0,l),l=-1));let n=-1,o=-1;return a.forEach((e=>{let t=r.findIndex((t=>e.tStep===t.tStep)),s=r.findLastIndex((t=>e.tStep+e.hStep===t.tStep+t.hStep));t>-1&&(n=0===t?0:Math.min(t,n)),s>-1&&(o=Math.max(s,o))})),a=a.filter((e=>e.tStep>=r[n].tStep&&e.tStep+e.hStep<=r[o].tStep+r[o].hStep)),{l_window:a,r_window:r}}({...e},JSON.parse(JSON.stringify(N))),U={hStep:A.r_window.reduce(((e,t)=>e+t.hStep),0),tStep:A.r_window[0].tStep,lStep:A.l_window[0].lStep},B=V(U,"x"),R.innerHTML+=B)})),document.querySelector(`#dom-item-${e.selectIndex}-bottom-border`).addEventListener("mousedown",(t=>{e.tStep+e.hStep!==k&&(_="bottom-border",D={y:0},W=0,A=function({hStep:e,tStep:t,selectIndex:s},i){let r=i.filter((s=>s.tStep+s.hStep===t+e)).sort(((e,t)=>e.lStep-t.lStep)),a=i.filter((s=>s.tStep===t+e)).sort(((e,t)=>e.lStep-t.lStep));for(var l=0;l<r.length-1;l++)r[l].lStep+r[l].wStep!==r[l+1].lStep&&(s<=r[l].selectIndex?r.splice(l+1):(r.splice(0,l),l=-1));let n=-1,o=-1;return a.forEach((e=>{let t=r.findIndex((t=>e.lStep===t.lStep)),s=r.findLastIndex((t=>e.lStep+e.wStep===t.lStep+t.wStep));t>-1&&(n=0===t?0:Math.min(t,n)),s>-1&&(o=Math.max(s,o))})),a=a.filter((e=>e.lStep>=r[n].lStep&&e.lStep+e.wStep<=r[o].lStep+r[o].wStep)),{t_window:a,b_window:r}}({...e},JSON.parse(JSON.stringify(N))),U={wStep:A.b_window.reduce(((e,t)=>e+t.wStep),0),lStep:A.b_window[0].lStep,tStep:A.t_window[0].tStep},B=V(U,"y"),R.innerHTML+=B)}))}))}function J(){R.innerHTML="",N=F(N),j(N)}z(),document.addEventListener("mousemove",(e=>{if(!_)return;let t=R.getBoundingClientRect(),s=t.width/k,i=t.height/k;switch(_){case"right-border":if(D.x+=e.movementX,W!==Math.round(D.x/s)){if(W=Math.round(D.x/s),U.lStep+W<=0)return void(W=1-U.lStep);if(U.lStep+W>=k)return void(W=k-U.lStep-1);document.querySelector("#division-move-line").style.left=(U.lStep+W)*T+"%"}break;case"bottom-border":if(D.y+=e.movementY,W!==Math.round(D.y/i)){if(W=Math.round(D.y/i),U.tStep+W<=0)return void(W=1-U.tStep);U.tStep+W>=k&&(W=k-U.tStep-1),document.querySelector("#division-move-line").style.top=(U.tStep+W)*T+"%"}}})),document.addEventListener("mouseup",(e=>{if(_){let e=[],t=!0;switch(_){case"right-border":if(!W)return;let{l_window:s,r_window:i}=A;if(e=[...s.map((e=>(e.wStep-=W,e.lStep+=W,e.wStep<1&&(t=!1),e))),...i.map((e=>(e.wStep+=W,e.wStep<1&&(t=!1),e)))],!t)return _="",document.querySelector("#division-move-line").remove(),J(),void L.onError("不能拖拽到当前位置，请重新拖拽");e.forEach((e=>N[e.selectIndex]=e));break;case"bottom-border":if(!W)return;let{t_window:r,b_window:a}=A;if(e=[...r.map((e=>(e.hStep-=W,e.tStep+=W,e.hStep<1&&(t=!1),e))),...a.map((e=>(e.hStep+=W,e.hStep<1&&(t=!1),e)))],!t)return _="",document.querySelector("#division-move-line").remove(),J(),void L.onError("不能拖拽到当前位置，请重新拖拽");e.forEach((e=>N[e.selectIndex]=e))}_="",J()}}));const X=e=>{let{division:t,windowId:s,callback:i}=e;if(E=document.querySelector(`#${s}`),E.innerHTML=function(e){return`<div id="${e}-container" style="width: 100%; height: 100%; border: 1px solid #aaa; position: relative;"></div>\n        <div class="window-division-bottom-container">\n            <button class="window-division-btn window-division-btn-primary" id="${e}-confirm-btn">确认</button>\n            <button class="window-division-btn window-division-btn-info" id="${e}-cancel-btn">取消</button>\n        </div>\n    `}(s),R=document.querySelector(`#${s}-container`),L=i,document.querySelector(`#${s}-confirm-btn`).addEventListener("click",(()=>{i.onConfirm&&i.onConfirm(JSON.stringify(N))})),document.querySelector(`#${s}-cancel-btn`).addEventListener("click",(()=>{i.onCancel&&i.onCancel()})),t)if([1,4,9,16,25].includes(Number(t)))!function(e=4){M=!0;let t=[],s=100/Math.sqrt(e);for(var i=0;i<e;i++)t.push({selectIndex:i,width:s,height:s});var r=t.map((e=>O(e)));R.innerHTML=r.join("")}(Number(t));else if("string"!=typeof t)i.onError&&i.onError("传入格式错误，请重新传入");else try{N=F(JSON.parse(t)),j(N)}catch(r){i.onError&&i.onError("传入格式错误，请重新传入")}else j(F())},q={selfAdaption:"自适应",stretching:"拉伸"};class H{constructor(e){if(!e.type)return console.error("type 为必传参数，请校验入参"),!1;if(this.options=e,this.type=e.type,this.config=i.mergeObject(b,e.config),this.setWSUrl=e.setWSUrl,this.WS_TIMEOUT=e.WS_TIMEOUT||1,this.protocol=e.protocol,this.isIntranet=e.isIntranet,this.intranetMap=e.intranetMap,this.proxyServerIp=e.proxyServerIp||e.serverIp,this.streamServerIp=e.streamServerIp||e.serverIp,this.prefixUrl=e.prefixUrl||"./static",this.rtspResponseTimeout=e.rtspResponseTimeout,this.procedure=new I({type:this.type,player:this,playCenterRecordByTime:this.config.playCenterRecordByTime,getRealRtsp:e.getRealRtsp,getRecords:e.getRecords,getRecordRtspByTime:e.getRecordRtspByTime,getRecordRtspByFile:e.getRecordRtspByFile,getTalkRtsp:e.getTalkRtsp}),this.sendMessage=e.receiveMessageFromWSPlayer||function(e,t,s){},this.el=e.el,this.fetchChannelAuthority=e.getChannelAuthority,this.$el=$("#"+this.el),this.$el.empty(),!this.$el.length)return void this.sendErrorMessage(503);this.width=this.$el.attr("width"),this.height=this.$el.attr("height"),this.$el.height(`${this.height}px`),this.$el.width(`${this.width}px`),this.$el.addClass("ws-player"),this.$el.append('<div class="player-wrapper"></div>'),this.$wrapper=$(".player-wrapper",this.$el),this.playerList=[],this.playerAdapter="selfAdaption",this.canvas={},this.ctx={},this.showNum=1,this.maxWindow=1,$(this.$el).attr("inited",!0);let{isVersionCompliance:t,browserType:s,errorCode:r}=i.checkBrowser(),a="https:"===location.protocol;switch(this.config.isDynamicLoadLib&&this.loadLibPlay(a,t),this.setMaxWindow(),this.beforeShowNum=1,this.type){case"real":this.createRealPlayer(e);break;case"record":this.createRecordPlayer(e)}this.setSelectIndex(0),this.setPlayerNum(this.config.division||this.config.num),this.setCanvasGetContext(),this.bindUpdatePlayerWindow=this.__updatePlayerWindow.bind(this),window.addEventListener("resize",this.bindUpdatePlayerWindow),window.wsPlayerManager||(window.wsPlayerManager=new w)}setCanvasGetContext(){var e;window.wsCanvasGetContextSet||(window.wsCanvasGetContextSet=!0,HTMLCanvasElement.prototype.getContext=(e=HTMLCanvasElement.prototype.getContext,function(t,s){return"webgl"===t&&(s=Object.assign({},s,{preserveDrawingBuffer:!0})),e.call(this,t,s)}))}setMaxWindow(){let e=parseInt(this.config.maxNum,10);this.maxWindow=e>16?25:e>9?16:e>4?9:e>1?4:1}createRealPlayer(){this.config.showControl?this.__addRealControl():this.$wrapper.addClass("nocontrol"),Array(this.maxWindow).fill(1).forEach(((e,t)=>{let s=new y({wrapperDomId:this.el,index:t,wsPlayer:this});this.playerList.push(s)}))}createRecordPlayer(){this.config.showRecordProgressBar&&this.__addRecordControl(),this.config.showControl&&this.__addRealControl(),!this.config.showRecordProgressBar&&!this.config.showControl&&this.$wrapper.addClass("nocontrol"),Array(this.maxWindow).fill(1).forEach(((e,t)=>{let s=new u({wrapperDomId:this.el,index:t,wsPlayer:this});this.playerList.push(s)}))}loadScript(e){let t=document.createElement("script");t.src=e,document.head.appendChild(t)}loadLibPlay(e,t){if(window.loadLibPlayerFlag)return void setTimeout((()=>{this.sendMessage("initializationCompleted")}),300);window.loadLibPlayerFlag=!0,window.m_nModuleInitialized=!1,window.Module||(window.Module={}),Module.onRuntimeInitialized=function(){window.m_nModuleInitialized=!0};let s=setInterval((()=>{window.m_nModuleInitialized&&(this.sendMessage("initializationCompleted"),clearInterval(s))}),100),i=`${this.prefixUrl}/WSPlayer/multiThread/libplay.js`;try{new SharedArrayBuffer(1)}catch(r){i=`${this.prefixUrl}/WSPlayer/singleThread/libplay.js`}e&&t&&!this.config.onlyLoadSingleLib||(i=`${this.prefixUrl}/WSPlayer/singleThread/libplay.js`),this.loadScript(i)}playReal(e){e.rtspURL?this.__getWSUrl(e.rtspURL,e.streamServerIp,e.wsList,e.playType).then((t=>{e.wsURL=e.wsURL||t,e.playerAdapter=e.playerAdapter||this.playerAdapter;let s=this.playerList[e.selectIndex];s.playType=e.playType,e.selectIndex+1<this.showNum?this.setSelectIndex(e.selectIndex+1):this.selectIndex===e.selectIndex&&s&&this.setPtzChannel(e.channelData),s&&s.init(e)})):console.error("播放实时视频需要传入rtspURL")}playRecord(e,t={}){return new Promise((s=>{let i=this.playerList[e.selectIndex];i.playType=e.playType,this.__getWSUrl(e.rtspURL,e.streamServerIp,e.wsList,e.playType).then((r=>{e.wsURL=e.wsURL||r,e.playerAdapter=e.playerAdapter||this.playerAdapter,e.isPlayback=!0,e.selectIndex+1<this.showNum&&!e.isJumpPlay?this.setSelectIndex(e.selectIndex+1):($(".ws-record-play",this.$el).css({display:"none"}),$(".ws-record-pause",this.$el).css({display:"block"}));for(let e in t)i[e]=t[e];i&&i.init(e),s()}))}))}openVolume(e){let t=this.playerList[void 0===e?this.selectIndex:e];!t.isAudioPlay&&$(".audio-icon",t.$el).click()}closeVolume(e){let t=this.playerList[void 0===e?this.selectIndex:e];t.isAudioPlay&&$(".audio-icon",t.$el).click()}setVolume(e,t){let s=this.playerList[void 0===e?this.selectIndex:e];!s.isAudioPlay&&$(".audio-icon",s.$el).click(),this.player.setAudioVolume(t)}picCap(e){let t=this.playerList[void 0===e?this.selectIndex:e];$(".capture-icon",t.$el).click()}play(e){let t=this.playerList[void 0===e?this.selectIndex:e];t?"pause"===t.status&&t.play():this.sendErrorMessage(601,{method:"play",arguments:{index:e}})}pause(e){let t=this.playerList[void 0===e?this.selectIndex:e];t?"playing"===t.status&&t.pause():this.sendErrorMessage(601,{method:"pause",arguments:{index:e}})}playSpeed(e,t){if("real"===this.type)return void this.sendErrorMessage(607,{method:"playSpeed",arguments:{speed:e,index:t}});let s=this.playerList[void 0===t?this.selectIndex:t];s?s.playSpeed(e-0):this.sendErrorMessage(601,{method:"playSpeed",arguments:{speed:e,index:t}})}setSelectIndex(e){if(this.selectIndex===e||void 0===e)return;let t=this.playerList[e];if(t){if(this.procedure&&this.procedure.setPlayIndex(e),"record"===this.type){let s=t.status;"playing"===s&&($(".ws-record-play",this.$el).css({display:"none"}),$(".ws-record-pause",this.$el).css({display:"block"})),["playing","pause"].includes(s)?this.procedure&&this.procedure.changeTimeLine(e):(this.setTimeLine([]),$(".ws-record-pause",this.$el).css({display:"none"}),$(".ws-record-play",this.$el).css({display:"block"})),this.__setPlaySpeed("",e)}this.sendMessage("selectWindowChanged",{channelId:(t.options||{}).channelId,playIndex:e}),this.selectIndex=e,this.setPtzChannel((t.options||{}).channelData),this.playerList.forEach(((t,s)=>{s===e?t.$el.removeClass("unselected").addClass("selected"):t.$el.removeClass("selected").addClass("unselected"),this.__updateVoice(t,s===e)}))}else this.sendErrorMessage(601,{method:"setSelectIndex",arguments:{index:e}})}createCustomDialog(){let e=`<div id="${this.el}-custom-container" class="custom-division-container"></div>`;this.$el.append(e),X({division:localStorage.customDivision||"",windowId:`${this.el}-custom-container`,callback:{onError:e=>{alert(e)},onConfirm:e=>{localStorage.customDivision=e,$(`#${this.el}-custom-container`).remove(),this.setCustomPlayer(e)},onCancel:()=>{$(`#${this.el}-custom-container`).remove()}}})}numberToList(e){let t=100/e,s=[];for(var i=0;i<e;i++)for(var r=0;r<e;r++)s.push({lStep:r*t,tStep:i*t,wStep:t,hStep:t});return s}renderPlayerNum(e,t){let s=[];s="number"==typeof t?this.numberToList(t):t;for(var i=0;i<e.length;i++){let t=e[i].getAttribute("id"),r=t.split("-"),a=Number(r[r.length-1]);if(s[a]){$(`#${t}`).css({top:`${s[a].tStep}%`,left:`${s[a].lStep}%`,width:`${s[a].wStep}%`,height:`${s[a].hStep}%`,visibility:"visible","z-index":10});let e=Math.max(s[a].wStep,s[a].hStep)/50;$(`#${t} .default-status`).css({transform:`scale(${e>1?1:e})`})}else $(`#${t}`).css({top:"150%",left:0,width:0,height:0,visibility:"hidden"})}}resetPlayerScreen(e,t){for(let s=0;s<t;s++)e[s]&&$(`#${e[s].getAttribute("id")}`).css({top:"150%",left:0,width:0,height:0,visibility:"hidden"})}setPlayerNum(e,t){switch(typeof e){case"number":this.setDefaultPlayer(e,t);break;case"string":this.setCustomPlayer(e,t)}}setDefaultPlayer(e,s){let i=$(`#${this.el} .wsplayer-item`);this.resetPlayerScreen(i,this.config.maxNum);let r=parseInt(e)||1;switch(r){case 1:r=1,this.renderPlayerNum(i,1);break;case 2:r=2,this.renderPlayerNum(i,[{lStep:0,tStep:0,wStep:50,hStep:100},{lStep:50,tStep:0,wStep:50,hStep:100}]);break;case 3:r=JSON.stringify(t.windowDefaultCustomDivision[3]),this.renderPlayerNum(i,t.windowDefaultCustomDivision[3]);break;case 4:r=4,this.renderPlayerNum(i,2);break;case 5:case 6:r=JSON.stringify(t.windowDefaultCustomDivision[6]),this.renderPlayerNum(i,t.windowDefaultCustomDivision[6]);break;case 7:case 8:r=JSON.stringify(t.windowDefaultCustomDivision[8]),this.renderPlayerNum(i,t.windowDefaultCustomDivision[8]);break;case 9:r=9,this.renderPlayerNum(i,3);break;case 10:case 11:case 12:case 13:case 14:case 15:case 16:r=16,this.renderPlayerNum(i,4);break;case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:r=25,this.renderPlayerNum(i,5)}r>this.maxWindow&&(r=this.maxWindow),this.showNum!==r&&(this.showNum=r,!s&&this.sendMessage("windowNumChanged",this.showNum),setTimeout((()=>{this.__updatePlayerWindow()}),200))}setCustomPlayer(e,t){let s=$(`#${this.el} .wsplayer-item`);this.resetPlayerScreen(s,this.config.maxNum),this.renderPlayerNum(s,JSON.parse(e)),this.showNum=e,!t&&this.sendMessage("windowNumChanged",this.showNum),setTimeout((()=>{this.__updatePlayerWindow()}),200)}setPlayerAdapter(e){this.playerAdapter!==e&&(["selfAdaption","stretching"].includes(e)?(this.playerAdapter=e,$(".ws-select-show-option",this.$el).text(q[e]),this.__updatePlayerWindow()):this.sendErrorMessage(606,{method:"setPlayerAdapter",arguments:{playerAdapter:e}}))}setTimeLine(e=[]){this.timeList=e,this.timeList.length?$("#ws-record-time-box",this.$el).css({visibility:"visible"}):$("#ws-record-time-box",this.$el).css({visibility:"hidden"}),this.__setTimeRecordArea(e)}setFullScreen(){let e=this.$el[0].children[0];e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen(),this.__updatePlayerWindow()}close(e){let t=Number(e);if(isNaN(t))return void this.playerList.forEach(((e,t)=>{e&&this.close(t)}));let s=this.playerList[t];s&&(s.close(),this.selectIndex===t&&this.setTimeLine([]))}destroy(){this.setTimeLine([]),this.playerList.forEach((e=>{e.close()})),window.removeEventListener("resize",this.bindUpdatePlayerWindow)}__addRealControl(){this.$el.append(`\n            <div class="ws-control">\n                <div class="ws-flex ws-control-record ws-flex-left">\n                    <div class="ws-ctrl-record-icon ws-record-play" style="display: none" title="播放"></div>\n                    <div class="ws-ctrl-record-icon ws-record-pause" title="暂停"></div>\n                    <div class="ws-ctrl-record-icon ws-record-speed-sub" title="倍速-"></div>\n                    <div class="ws-ctrl-record-icon ws-record-speed-txt">1x</div>\n                    <div class="ws-ctrl-record-icon ws-record-speed-add" title="倍速+"></div>\n                </div>\n                <div class="ws-flex ws-flex-end">\n                    <div class="ws-select-self-adaption">\n                        <div class="ws-select-show select">\n                            <div class="ws-select-show-option">自适应</div>\n                            \x3c!-- 下拉箭头 --\x3e\n                            <img src="${this.prefixUrl}/WSPlayer/icon/spread.png" />\n                        </div>\n                        <div class="ws-self-adaption-type" style="display: none">\n                            <ul class="ws-select-ul">\n                                <li optionValue="自适应" value="selfAdaption" class="ws-select-type-item">自适应</li>\n                                <li optionValue="拉伸" value="stretching" class="ws-select-type-item">拉伸</li>\n                            </ul>\n                        </div>\n                    </div>\n                    <span class="ws-ctrl-btn-spread"></span>\n                    <div class="ws-ctrl-icon close-all-video" title="一键关闭"></div>\n                    <span class="ws-ctrl-btn-spread"></span>\n                    <div class="ws-ctrl-icon one-screen-icon" title="单屏"></div>\n                    <div class="ws-ctrl-icon four-screen-icon" title="4分屏"></div>\n                    <div class="ws-ctrl-icon nine-screen-icon" title="9分屏"></div>\n                    <div class="ws-ctrl-icon sixteen-screen-icon" title="16分屏"></div>\n                    <div class="ws-ctrl-icon twenty-five-screen-icon" title="25分屏"></div>\n                    <div class="ws-ctrl-icon custom-screen-icon" title="自定义分屏"></div>\n                    <span class="ws-ctrl-btn-spread"></span>\n                    <div class="ws-ctrl-icon full-screen-icon" title="全屏"></div>\n                </div>\n            </div>\n        `),this.maxWindow<=16&&$(".twenty-five-screen-icon",this.$el).css({display:"none"}),this.maxWindow<=9&&$(".sixteen-screen-icon",this.$el).css({display:"none"}),this.maxWindow<=4&&$(".nine-screen-icon",this.$el).css({display:"none"}),1===this.maxWindow&&($(".four-screen-icon",this.$el).css({display:"none"}),$(".one-screen-icon",this.$el).css({display:"none"})),$(".full-screen-icon",this.$el).click((()=>{this.setFullScreen()})),$(".one-screen-icon",this.$el).click((()=>{this.setPlayerNum(1)})),$(".four-screen-icon",this.$el).click((()=>{this.setPlayerNum(4)})),$(".nine-screen-icon",this.$el).click((()=>{this.setPlayerNum(9)})),$(".sixteen-screen-icon",this.$el).click((()=>{this.setPlayerNum(16)})),$(".twenty-five-screen-icon",this.$el).click((()=>{this.setPlayerNum(25)})),$(".close-all-video",this.$el).click((()=>{this.close()})),$(".custom-screen-icon",this.$el).click((()=>{this.createCustomDialog()})),this.selfAdaptionSelectShow=!1,$(".ws-select-self-adaption",this.$el).click((e=>{this.selfAdaptionSelectShow?($(".ws-self-adaption-type",this.$el).hide(),this.selfAdaptionSelectShow=!1):($(".ws-self-adaption-type",this.$el).show(),this.selfAdaptionSelectShow=!0,$(".ws-select-ul .ws-select-type-item",this.$el).css({background:"none"}),$(`.ws-select-ul [value=${this.playerAdapter}]`,this.$el).css({background:"#1A78EA"}))})),$(".ws-self-adaption-type",this.$el).click((e=>{let t=e.target.getAttribute("value");this.setPlayerAdapter(t),$(".ws-select-show-option",this.$el).text(q[t])})),"record"!==this.type&&$(".ws-control-record",this.$el).css({display:"none"}),$(".ws-record-pause",this.$el).click((e=>{this.pause()})),$(".ws-record-play",this.$el).click((e=>{this.play()})),$(".ws-record-speed-sub",this.$el).click((e=>{"playing"===this.playerList[this.selectIndex].status&&this.__setPlaySpeed("PREV")})),$(".ws-record-speed-add",this.$el).click((e=>{"playing"===this.playerList[this.selectIndex].status&&this.__setPlaySpeed("NEXT")}))}__setPlaySpeed(e,t){let s,i,r=[{value:.125,label:"0.125x"},{value:.25,label:"0.25x"},{value:.5,label:"0.5x"},{value:1,label:"1x"},{value:1.25,label:"1.25x"},{value:1.5,label:"1.5x"},{value:2,label:"2x"},{value:4,label:"4x"},{value:8,label:"8x"}],a=this.playerList[void 0===t?this.selectIndex:t];r.some(((l,n)=>{if(l.value===a.speed)return i="PREV"===e?n-1:"NEXT"===e?n+1:n,s=r[i],!s||(i?i===r.length-1?$(".ws-record-speed-add",this.$el).css({cursor:"not-allowed"}):($(".ws-record-speed-sub",this.$el).css({cursor:"pointer"}),$(".ws-record-speed-add",this.$el).css({cursor:"pointer"})):$(".ws-record-speed-sub",this.$el).css({cursor:"not-allowed"}),$(".ws-record-speed-txt",this.$el).text(s.label),"playing"===a.status&&this.playSpeed(s.value,t),!0)}))}__addRecordControl(){this.$el.append('\n            <div class="ws-control ws-record-control">\n                <div class="ws-timeline">\n                    <div class="ws-timeline-group"></div>\n                    <div class="ws-timeline-group"></div>\n                </div>\n                \x3c!--当前播放的时间点--\x3e\n                <div id="ws-record-time-box">\n                    <div class=\'ws-record-time\'>\n                        <span></span>\n                    </div>\n                </div>\n                <canvas height="60" id="ws-record-canvas" class="ws-record-area"/>\n            </div>\n        '),this.canvas=document.getElementById("ws-record-canvas"),this.ctx=this.canvas.getContext("2d");let e=$(this.$el[0].getElementsByClassName("ws-timeline-group")[0],this.$el),t=$(this.$el[0].getElementsByClassName("ws-timeline-group")[1],this.$el);new Array(49).fill(1).forEach(((t,s)=>{let i="ws-time-space "+(s%4?"":"ws-time-space-long");e.append(`<span class="${i}"></span>`)})),new Array(13).fill(1).forEach(((e,s)=>{t.append(`<span class="ws-time-point">${(2*s+":00").padStart(5,"0")}</span>`)})),$(".ws-record-control",this.$el).mouseenter((e=>{$(".ws-record-control").append("<div id='ws-cursor'><div class='ws-cursor-time'><span></span></div></div>")})),$(".ws-record-control",this.$el).mousemove((e=>{let t=$(".ws-record-control",this.$el).width(),s=e.clientX-$(".ws-record-control",this.$el)[0].getBoundingClientRect().left,i=new Date(1e3*(s/t*24*60*60-28800)),r=`${`${i.getHours()}`.padStart(2,"0")}:${`${i.getMinutes()}`.padStart(2,"0")}:${`${i.getSeconds()}`.padStart(2,"0")}`;$("#ws-cursor",this.$el).css("left",s),$("#ws-cursor span",this.$el).text(r)})),$(".ws-record-control",this.$el).mouseleave((e=>{$("#ws-cursor",this.$el).remove()})),$(".ws-record-control",this.$el).click((e=>{if(["playing","pause"].includes((this.playerList[this.selectIndex]||{}).status)){let t=$(".ws-record-control",this.$el).width(),s=e.clientX-$(".ws-record-control",this.$el)[0].getBoundingClientRect().left,i=parseInt(s/t*24*60*60,10);this.clickRecordTimeLine(i)}}))}__setTimeRecordArea(e=[]){if(e.length){let t=$(".ws-record-control",this.$el).width();this.canvas.width=t;let s=[],i=[],r=this.ctx.createLinearGradient(0,0,0,60);r.addColorStop(0,"rgba(77, 201, 233, 0.1)"),r.addColorStop(1,"#1c79f4");let a=this.ctx.createLinearGradient(0,0,0,60);a.addColorStop(0,"rgba(251, 121, 101, 0.1)"),a.addColorStop(1,"#b52c2c"),e.forEach((e=>{e.width=(e.endTime-e.startTime)*t/86400;let r=new Date(1e3*e.startTime),a=r.getHours(),l=r.getMinutes(),n=r.getSeconds();e.left=(3600*a+60*l+n)/86400*t,e.isImportant?i.push(e):s.push(e)})),s.forEach((e=>{this.ctx.clearRect(e.left,0,e.width,60),this.ctx.fillStyle=r,this.ctx.fillRect(e.left,0,e.width,60)})),i.forEach((e=>{this.ctx.clearRect(e.left,0,e.width,60),this.ctx.fillStyle=a,this.ctx.fillRect(e.left,0,e.width,60)}))}else this.canvas.width=0}__setPlayingTime(e,t,s,i,r,a,l){if(this.selectIndex===e){let e=(3600*r+60*a+l)/86400*$(".ws-record-control").width(),t=`${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}:${String(l).padStart(2,"0")}`;$("#ws-record-time-box",this.$el).css("left",e),$("#ws-record-time-box span",this.$el).text(t)}}autoSetWSUrl(e,t){return new Promise(((s,i)=>{if("wss"===t&&this.config.useNginxProxy)return void i({code:-106,message:"代理模式, 此模式不做自动处理"});e=e.map((e=>{if("wss"===t){let s=e.split(":")[0];return"real"===this.type?t+"://"+s+":9102":t+"://"+s+":9322"}if("ws"===t)return t+"://"+e}));let r=0,a=t=>{let l,n=new WebSocket(t),o=!1;n.onopen=()=>{o=!0,clearTimeout(l),n.close(),s(e[r-1])},n.onerror=()=>{clearTimeout(l),o=!1,r===e.length?i({code:-105,message:"自动识别失败，存在端口为非默认端口，开始通过参数判断，请注意传参！"}):a(e[r++])},l=setTimeout((()=>{!o&&n.close()}),1e3*this.WS_TIMEOUT)};a(e[r++])}))}__getWSUrl(e,s,i,r){return new Promise(((a,l)=>{if("url"===r)return void a();if(this.setWSUrl)return void a(this.setWSUrl(i));let n="https:"===location.protocol,o=e.match(/\d{1,3}(\.\d{1,3}){3}/g)[0];o||(o=e.split("//")[1].split(":")[0]);let d=this.protocol||(n?"wss":"ws");this.autoSetWSUrl(i,d).then((e=>{a(e)})).catch((e=>{if(console.warn(e.message),this.intranetMap){for(var i in this.intranetMap)i.includes(s)&&(s=i);this.streamServerIp=this.isIntranet?s:this.intranetMap[s]}if(this.config.useNginxProxy){let e="real"===this.type?t.websocketPorts.realmonitor:t.websocketPorts.playback;return this.proxyServerIp||(console.warn("确认您当前使用了代理模式，请传入proxyServerIp字段"),console.warn("此方式为没有购买证书的备选方案，不推荐使用。"),console.warn("在线文档地址 https://open-icc.dahuatech.com/wsplayer/"),console.warn(`如您确认需要使用此模式，请访问该连接下载文档查看 ${window.location.origin}/wsplayer/doc/代理模式.md`)),void a(`${d}://${this.proxyServerIp}/${e}?serverIp=${this.streamServerIp||s||o}`)}if(!this.streamServerIp)return console.warn("请根据不同大华平台场景进行传参播放视频画面！！详情可查阅文档-快速入门"),console.warn("在线文档地址 https://open-icc.dahuatech.com/wsplayer/"),void l();if(this.streamServerIp.includes(":"))return void a(`${d}://${this.streamServerIp}`);let r="";r="wss"===d?"real"===this.type?t.websocketPorts.realmonitor_wss:t.websocketPorts.playback_wss:"real"===this.type?t.websocketPorts.realmonitor_ws:t.websocketPorts.playback_ws,a(`${d}://${this.streamServerIp}:${r}`)}))}))}__updatePlayerWindow(){setTimeout((()=>{this.playerList.forEach((e=>{e.updateAdapter(this.playerAdapter)})),this.setTimeLine(this.timeList)}),24)}__updateVoice(e,t){t?$(".audio-icon",e.$el).hasClass("on")&&e.player.setAudioVolume(1):e.player&&e.player.setAudioVolume(0)}__startTalk(e){this.procedure&&this.procedure.startTalk(e)}talkByUrl(e){this.playerList[e.selectIndex].talkByUrl(e)}playRealVideo(e,t="2",s){this.procedure&&this.procedure.playRealVideo(e,t,s)}changeStreamType(e,t,s){this.procedure&&this.procedure.playRealVideo([e],t,s)}getRecordList(e){this.procedure&&this.procedure.getRecordList(e)}clickRecordTimeLine(e){let t=new Date(1e3*this.timeList[0].startTime).setHours(0,0,0)/1e3+e;this.timeList.some((s=>{if(t>=s.startTime&&t<s.endTime){let t=this.playerList[this.selectIndex];if(t.options.playRecordByTime&&t.options.ssId===s.ssId)t.player.playByTime(e);else{if("url"===t.playType)return void this.sendMessage("switchStartTime",t.options.channelData);this.procedure&&this.procedure.clickRecordTimeLine(e,s.ssId)}return!0}}))||console.warn("所选时间点无录像")}jumpPlayByTime(e){let t=e.split(":"),s=60*(t[0]||0)*60+60*(t[1]||0)+1*(t[2]||0);3!==t.length||!s||s>=86400?this.sendErrorMessage(605,{method:"jumpPlayByTime",arguments:{time:e}}):this.clickRecordTimeLine(s)}playNextRecord(e,t){this.procedure&&this.procedure.playNextRecord(e,t)}videoClosed(e,t,s){this.sendMessage("closeVideo",{selectIndex:e,changeVideoFlag:t,channelData:s}),this.procedure&&this.procedure.videoClosed(e,t,s)}sendErrorMessage(e,s={}){let i=t.errorInfo[e];s.insert&&(s.insert.forEach(((e,t)=>{i=i.replace(`$${t}`,e)})),delete s.insert),this.sendMessage("errorInfo",{errorCode:e,errorInfo:i,errorData:s})}startLocalRecord(e,t,s=!0){let i=this.playerList[e];i?"playing"===i.status&&"pause"===i.status?i.isRecording?this.sendErrorMessage(602,{method:"startLocalRecord",arguments:{selectIndex:e,name:name,size:t,downloadMp4Record:s}}):(i.isRecording=!0,i.player.startLocalRecord(name,t,s),$(".record-icon",i.$el).addClass("recording")):this.sendErrorMessage(603,{method:"startLocalRecord",arguments:{selectIndex:e,name:name,size:t,downloadMp4Record:s}}):this.sendErrorMessage(601,{method:"startLocalRecord",arguments:{selectIndex:e,name:name,size:t,downloadMp4Record:s}})}stopLocalRecord(e){let t=this.playerList[e];t?t.isRecording?(t.isRecording=!1,t.player.stopLocalRecord(),$(".record-icon",t.$el).removeClass("recording")):this.sendErrorMessage(604,{method:"stopLocalRecord",arguments:{selectIndex:e}}):this.sendErrorMessage(601,{method:"stopLocalRecord",arguments:{selectIndex:e}})}setIvs(e,t,s){let i=this.playerList[t];e?i.openIVS():i.closeIVS()}initPanTilt(e){this.panTilt=new x({...e,prefixUrl:this.prefixUrl},this)}setPtzChannel(e){this.panTilt&&this.panTilt.setChannel(e)}}__publicField(H,"version","1.2.9"),e.WSPlayer=H,e.default=H,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
